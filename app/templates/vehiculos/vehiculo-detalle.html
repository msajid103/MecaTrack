{% extends 'base.html' %}
{% block content %}
<!-- Contenido principal -->
<main class="col-md-9 ms-sm-auto col-lg-10 px-md-4">
    <!-- Barra superior con botón de menú para móviles y usuario -->
    <div
        class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
        <div>
            <button class="btn d-md-none" type="button" data-bs-toggle="collapse" data-bs-target="#sidebar">
                <i class="fas fa-bars"></i>
            </button>
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item"><a href="/">Dashboard</a></li>
                    <li class="breadcrumb-item"><a href="vehiculos.html">Vehículos</a></li>
                    <li class="breadcrumb-item active" aria-current="page">{{ vehiculo.marca }} {{ vehiculo.modelo }} (
                        {{ vehiculo.matricula }})</li>
                </ol>
            </nav>
            <h1 class="h2">Detalle de Vehículo</h1>
        </div>
        <div class="btn-toolbar mb-2 mb-md-0">
            <div class="btn-group me-2">
                <button type="button" class="btn btn-primary" data-bs-toggle="modal"
                    data-bs-target="#editVehiculoModal">
                    <i class="fas fa-edit me-1"></i> Editar
                </button>
                <button type="button" class="btn btn-danger" data-bs-toggle="modal"
                    data-bs-target="#deleteVehiculoModal">
                    <i class="fas fa-trash me-1"></i> Eliminar
                </button>
            </div>
            <a href="{{ url_for('reparaciones.registrar') }}" class="btn btn-success">
                <i class="fas fa-tools me-1"></i> Nueva Reparación
            </a>
        </div>
    </div>

    <!-- Información del vehículo -->
    <div class="row">
        <!-- Columna de información general -->
        <div class="col-md-4 mb-4">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">Información General</h5>
                </div>
                <div class="card-body">
                    <div class="text-center mb-4">
                        <div class="vehicle-icon-large mb-3">
                            <i class="fas fa-car fa-3x"></i>
                        </div>
                        <h4>{{ vehiculo.marca }} {{ vehiculo.modelo }}</h4>
                        <p class="text-muted">Matrícula: {{ vehiculo.matricula }}</p>
                        <span class="badge bg-warning">{{ vehiculo.estado }}</span>
                    </div>
                    <hr>
                    <div class="info-list">
                        <div class="info-item">
                            <span class="info-label"><i class="fas fa-user me-2"></i>Propietario</span>
                            <span class="info-value"><a href="cliente-detalle.html">
                                    {% for c in clientes %}
                                    {% if c.id == vehiculo.idcliente %} {{ c.nombre }} {% endif %}
                                    {% endfor %}
                                </a></span>
                        </div>
                        <div class="info-item">
                            <span class="info-label"><i class="fas fa-calendar-alt me-2"></i>Año</span>
                            <span class="info-value">{{ vehiculo.anio }}</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label"><i class="fas fa-tag me-2"></i>Tipo</span>
                            <span class="info-value">{{ vehiculo.tipo }}</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label"><i class="fas fa-palette me-2"></i>Color</span>
                            <span class="info-value">{{ vehiculo.color }}</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label"><i class="fas fa-tachometer-alt me-2"></i>Kilometraje</span>
                            <span class="info-value">{{ vehiculo.kilometraje }} km</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label"><i class="fas fa-calendar-check me-2"></i>Última revisión</span>
                            <span class="info-value">{{ vehiculo.fecha_estimada }}</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label"><i class="fas fa-sticky-note me-2"></i>Notas</span>
                            <span class="info-value">{{ vehiculo.notas }}</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Columna de historial y reparaciones -->
        <div class="col-md-8">
            <!-- Estadísticas -->
            <div class="row mb-4">
                <div class="col-md-4">
                    <div class="card dashboard-card">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <h6 class="card-subtitle mb-1 text-muted">Reparaciones Activas</h6>
                                    <h2 class="card-title mb-0">{{ total_activas | length }}</h2>
                                </div>
                                <div class="dashboard-icon bg-warning-light">
                                    <i class="fas fa-tools"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="card dashboard-card">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <h6 class="card-subtitle mb-1 text-muted">Total Reparaciones</h6>
                                    <h2 class="card-title mb-0">{{ vehiculo_reparaciones | length }}</h2>
                                </div>
                                <div class="dashboard-icon bg-primary-light">
                                    <i class="fas fa-history"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="card dashboard-card">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <h6 class="card-subtitle mb-1 text-muted">Gasto Total</h6>
                                    <h2 class="card-title mb-0">{{ gasto_total }}€</h2>
                                </div>
                                <div class="dashboard-icon bg-success-light">
                                    <i class="fas fa-euro-sign"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Historial de reparaciones -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0">Historial de Reparaciones</h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>Descripción</th>
                                    <th>Mecánico</th>
                                    <th>Fecha</th>
                                    <th>Estado</th>
                                    <th>Coste</th>
                                    <th>Acciones</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for r in vehiculo_reparaciones %}
                                <tr>
                                    <td>#{{ loop.index }}</td>
                                    <td>{{ r.descripcion_problema }}</td>
                                    <td>
                                        {% for m in mecanicos %}
                                        {% if m.id == r.mecanico %}{{ m.nombre }}{% endif %}
                                        {% endfor %}
                                    </td>
                                    <td>{{ r.fecha_entrada }}</td>
                                    <td><span class="badge bg-success">Completada</span></td>
                                    <td>{{ r.total }} €</td>
                                    <td>
                                        <a href="{{ url_for('reparaciones.detalle', id=r.id) }}"
                                            class="btn btn-sm btn-info">
                                            <i class="fas fa-eye"></i>
                                        </a>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Mantenimiento programado -->
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">Mantenimiento Programado</h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>Servicio</th>
                                    <th>Último</th>
                                    <th>Próximo</th>
                                    <th>Kilometraje</th>
                                    <th>Estado</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td>Cambio de aceite</td>
                                    <td>15/05/2023</td>
                                    <td>15/11/2023</td>
                                    <td>50.000 km</td>
                                    <td><span class="badge bg-success">Al día</span></td>
                                </tr>
                                <tr>
                                    <td>Cambio de filtros</td>
                                    <td>15/05/2023</td>
                                    <td>15/11/2023</td>
                                    <td>50.000 km</td>
                                    <td><span class="badge bg-success">Al día</span></td>
                                </tr>
                                <tr>
                                    <td>Revisión de frenos</td>
                                    <td>05/03/2023</td>
                                    <td>05/09/2023</td>
                                    <td>50.000 km</td>
                                    <td><span class="badge bg-warning">Próximamente</span></td>
                                </tr>
                                <tr>
                                    <td>Cambio de correa de distribución</td>
                                    <td>-</td>
                                    <td>-</td>
                                    <td>90.000 km</td>
                                    <td><span class="badge bg-primary">Pendiente</span></td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    <div class="d-flex justify-content-end mt-3">
                        <button class="btn btn-primary">
                            <i class="fas fa-bell me-1"></i> Programar Recordatorio
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</main>


<!-- Modal para editar vehículo -->
<div class="modal fade" id="editVehiculoModal" tabindex="-1" aria-labelledby="editVehiculoModalLabel"
    aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="editVehiculoModalLabel">Editar Vehículo</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <!-- Formulario para editar vehículo (con datos precargados) -->
                <form id="editVehiculoForm" method="POST">
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="editCliente" class="form-label">Cliente</label>
                            <select class="form-select" id="editCliente" name="idcliente" required>
                                <option value="">Seleccionar cliente</option>
                                {% for c in clientes %}
                                {% if vehiculo.idcliente == c.id %}
                                <option value="{{ c.id }}" selected>{{ c.nombre }}</option>
                                {% else %}
                                <option value="{{ c.id }}">{{ c.nombre }}</option>
                                {% endif %}
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label for="editTipo" class="form-label">Tipo</label>
                            <select class="form-select" id="editTipo" name="tipo" required>
                                <option value="{{ vehiculo.tipo}}">Seleccionar tipo</option>
                                <option value="Turismo" selected>Turismo</option>
                                <option value="Motocicleta">Motocicleta</option>
                                <option value="Furgoneta">Furgoneta</option>
                                <option value="Camión">Camión</option>
                                <option value="Otro">Otro</option>
                            </select>
                        </div>
                    </div>
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="editMarca" class="form-label">Marca</label>
                            <input type="text" class="form-control" id="editMarca" value="{{ vehiculo.marca}}"
                                name="marca" required>
                        </div>
                        <div class="col-md-6">
                            <label for="editModelo" class="form-label">Modelo</label>
                            <input type="text" class="form-control" id="editModelo" value="{{ vehiculo.modelo}}"
                                name="modelo" required>
                        </div>
                    </div>
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="editMatricula" class="form-label">Matrícula</label>
                            <input type="text" class="form-control" id="editMatricula" value="{{ vehiculo.matricula}}"
                                name="matricula" required>
                        </div>
                        <div class="col-md-6">
                            <label for="editAnio" class="form-label">Año</label>
                            <input type="number" class="form-control" id="editAnio" value="{{ vehiculo.anio}}"
                                name="anio" required>
                        </div>
                    </div>
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="editColor" class="form-label">Color</label>
                            <input type="text" class="form-control" id="editColor" name="color"
                                value="{{ vehiculo.color}}">
                        </div>
                        <div class="col-md-6">
                            <label for="editKilometraje" class="form-label">Kilometraje</label>
                            <input type="number" class="form-control" id="editKilometraje" name="kilometraje"
                                value="{{ vehiculo.kilometraje}}">
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="editNotas" class="form-label">Notas adicionales</label>
                        <textarea class="form-control" id="editNotas" name="notas"
                            rows="3">{{ vehiculo.notas}}</textarea>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                        <button type="submit" class="btn btn-primary" id="saveEditVehiculoBtn">Guardar Cambios</button>

                    </div>
                </form>
            </div>

        </div>
    </div>
</div>


<!-- Modal para confirmar eliminación -->
<div class="modal fade" id="deleteVehiculoModal" tabindex="-1" aria-labelledby="deleteVehiculoModalLabel"
    aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="deleteVehiculoModalLabel">Confirmar Eliminación</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p id="deleteModalText">¿Está seguro de que desea eliminar el vehículo <strong>{{ vehiculo.marca }} {{
                        vehiculo.modelo }} (
                        {{ vehiculo.matricula }})</strong>?</p>
                <p class="text-danger">Esta acción no se puede deshacer. Se eliminarán también todas las reparaciones
                    asociadas a este vehículo.</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <a id="confirmDeleteBtn" href="{{ url_for('vehiculos.borrar', id = vehiculo.id ) }}"
                    class="btn btn-danger">Eliminar</a>
            </div>
        </div>
    </div>
</div>

<!-- Bootstrap JS y Popper.js -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>

    document.addEventListener('DOMContentLoaded', function () {
        document.querySelectorAll('.edit-btn').forEach(button => {
            button.addEventListener('click', function () {
                // Get vehicle data from attributes
                const id = this.getAttribute('data-id');
                const cliente = this.getAttribute('data-cliente');
                const tipo = this.getAttribute('data-tipo');
                const marca = this.getAttribute('data-marca');
                const modelo = this.getAttribute('data-modelo');
                const matricula = this.getAttribute('data-matricula');
                const anio = this.getAttribute('data-anio');
                const color = this.getAttribute('data-color');
                const kilometraje = this.getAttribute('data-kilometraje');
                const notas = this.getAttribute('data-notas');

                // Populate the modal fields
                document.getElementById('editCliente').value = cliente;
                document.getElementById('editTipo').value = tipo;
                document.getElementById('editMarca').value = marca;
                document.getElementById('editModelo').value = modelo;
                document.getElementById('editMatricula').value = matricula;
                document.getElementById('editAnio').value = anio;
                document.getElementById('editColor').value = color;
                document.getElementById('editKilometraje').value = kilometraje;
                document.getElementById('editNotas').value = notas;


                const clienteSelect = document.getElementById('editCliente');

                // Set selected option by value (ID)
                for (let option of clienteSelect.options) {
                    if (option.value === cliente) {
                        option.selected = true;
                        break;
                    }
                }
                // Update the form action to include the vehicle ID
                const form = document.getElementById('editVehiculoForm');
                form.action = `/vehiculos/editar/${id}`; // Adjust the route if different
            });
        });

        // Submit form when save button clicked
        document.getElementById('saveEditVehiculoBtn').addEventListener('click', function () {
            document.getElementById('editVehiculoForm').submit();
        });
    });
</script>
{% endblock %}